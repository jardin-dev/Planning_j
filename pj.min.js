/*!
 * Planning 
 * Version: 2.5 17/04/23 
 *
 * Copyright (c) 2019 - 2023 ALL RIGHTS RESERVED
 * auteur Mickael FEUVRIER
 * 
*/

$(()=>{$("<div />").attr("id","drawer").appendTo("#planning"),$("<div />").attr("id","toolbar").appendTo("#drawer"),$("<div />").attr("id","context-menu").appendTo("#drawer"),$("<div />").attr("id","scheduler").appendTo("#drawer"),$("<div />").attr("id","loadpanel").appendTo("#planning");class modifStore{constructor(type,val){this.type=type,this.value=val}}class equipDefaultSalID{constructor(equipeID,salarieID){if(void 0!==salarieID)return salarieID;{let equipe;return $.grep(TEAMS_STORE._array,e=>e.id===equipeID)[0].defautSalId}}}class queryFM{constructor(script,param,option){this.script=script,this.param=param,this.option=option}}let appointmentDownloaded=[],popupOption=null,toastOption=null,popupDevisInfo=null,popupTimeResult=null,popupContacter=null,popupSMS=null,popupAddClient=null,isDrag=!0,isAdd=!0;const W_HEIGHT=$(window).height(),S_IN_H=36e5;let cellContextMenuItems=[{text:"Nouveau",onItemClick:createAppointment,disabled:!1},{text:"Grouper par équipe",beginGroup:!0,onItemClick:groupCell},{text:"Aller à aujourd'hui",onItemClick:showCurrentDate}],appointmentContextMenuItems=[{text:"Ouvrir",onItemClick:showAppointment},{text:"Supprimer",onItemClick:deleteAppointment},{text:"Dupliquer",onItemClick:duplicateAppointment},{text:"Statut",beginGroup:!0,items:[{text:"Rendez-vous",onItemClick:changeStatut},{text:"Message",onItemClick:changeStatut},{text:"Non appelé",onItemClick:changeStatut},{text:"Défaut",onItemClick:changeStatut}]},{text:"Salarié",items:[]},{text:"Détail",beginGroup:!0,onItemClick:createPopupDevisInfo},{text:"Fiche travaux",onItemClick:ficheTrav},{text:"Contacter",onItemClick:contactClient},{text:"Suivi de chantier",beginGroup:!0,onItemClick:createPopupTimeResult}];getDataAppointmentFM(new Date),getDataAnnuelFM(getParamAnnuel(new Date)),queryToFM(new queryFM("getDataAppointmentList","",0)),queryToFM(new queryFM("getDataParam","",0)),queryToFM(new queryFM("getDataEquipe","",0)),queryToFM(new queryFM("getDataPonctuel","",0)),queryToFM(new queryFM("getDataOffice","",0)),queryToFM(new queryFM("getDataJourChome","",0)),queryToFM(new queryFM("getDataSalarie","",0)),queryToFM(new queryFM("getDataAbsence","",0)),queryToFM(new queryFM("getListClients","",0));const CLIENT_STORE=new DevExpress.data.ArrayStore({data:[],key:"clt_ref"}),CLIENT_SOURCE=new DevExpress.data.DataSource({store:CLIENT_STORE,paginate:!0,reshapeOnPush:!1,pageSize:100}),APPOINTMENT_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onInserted:e=>{let val;appointementChangeFM(new modifStore("insert",e))},onUpdated:(key,e)=>{let val;appointementChangeFM(new modifStore("update",e))},onRemoved:key=>{let val;appointementChangeFM(new modifStore("remove",key))}}),APPOINTMENT_SOURCE=new DevExpress.data.DataSource({store:APPOINTMENT_STORE,paginate:!1,reshapeOnPush:!0}),APPOINTMENT_LIST_STORE=new DevExpress.data.ArrayStore({data:[],key:"id"}),APPOINTMENT_LIST_SOURCE=new DevExpress.data.DataSource({store:APPOINTMENT_LIST_STORE,paginate:!1,reshapeOnPush:!0}),ANNUEL_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onPush:e=>{let newliste;$("#list1").empty(),createList(ANNUEL_STORE._array)}}),ANNUEL_SOURCE=new DevExpress.data.DataSource({store:ANNUEL_STORE,paginate:!1,reshapeOnPush:!0}),PONCTUEL_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onPush:e=>{let newliste;$("#list2").empty(),createList(PONCTUEL_STORE._array)}}),PONCTUEL_SOURCE=new DevExpress.data.DataSource({store:PONCTUEL_STORE,paginate:!1,reshapeOnPush:!0}),OFFICE_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onInserted:value=>{SQL_InsertFM("Office",value)},onUpdated:(key,value)=>{delete value.id,SQL_UpdateFM("Office",key,value)},onRemoved:key=>{SQL_removeFM("Office",key)}}),OFFICE_SOURCE=new DevExpress.data.DataSource({store:OFFICE_STORE,paginate:!1,reshapeOnPush:!0}),ABSENCE_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onInserted:value=>{SQL_InsertFM("Absence",value)},onUpdated:(key,value)=>{delete value.id,SQL_UpdateFM("Absence",key,value)},onRemoved:key=>{SQL_removeFM("Absence",key)}}),ABSENCE_SOURCE=new DevExpress.data.DataSource({store:ABSENCE_STORE,paginate:!1,reshapeOnPush:!0}),CHOME_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onInserted:value=>{SQL_InsertFM("Chome",value)},onUpdated:(key,value)=>{delete value.id,SQL_UpdateFM("Chome",key,value)},onRemoved:key=>{SQL_removeFM("Chome",key)}}),SALARIE_STORE=new DevExpress.data.ArrayStore({name:"salarie",data:[],key:"id",onInserted:value=>{SQL_InsertFM("Salarie",value)},onUpdated:(key,value)=>{SQL_UpdateFM("Salarie",key,value)},onRemoved:key=>{SQL_removeFM("Salarie",key)}}),SALARIE_SOURCE=new DevExpress.data.DataSource({store:SALARIE_STORE,paginate:!1,reshapeOnPush:!0}),TEAMS_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onInserted:value=>{SQL_InsertFM("Equipe",value)},onUpdated:(key,value)=>{SQL_UpdateFM("Equipe",key,value)},onRemoved:key=>{SQL_removeFM("Equipe",key)}}),PARAM_STORE=new DevExpress.data.ArrayStore({data:[],key:"id",onUpdated:(key,value)=>{SQL_UpdateFM("Parametre",key,value)}});DevExpress.localization.locale(navigator.language);const FORMAT=DevExpress.localization.formatMessage,SCHEDULER_TOOLBAR=$("#toolbar").dxToolbar({elementAttr:{class:"toolbar_header"},items:[{widget:"dxButton",location:"before",options:{icon:"menu",onClick:()=>{DRAWER.toggle();let val=!0===DRAWER.option("opened")?1:0;PARAM_STORE.update(PARAM_STORE._array[0].id,{drawer:val})},elementAttr:{class:"buttonPanel"}}}]}).dxToolbar("instance"),DRAWER=$("#drawer").dxDrawer({opened:!1,height:W_HEIGHT,elementAttr:{class:"drawer-planning"},width:"100%",closeOnOutsideClick:!1,openedStateMode:"shrink",template:()=>{let panelAccordionContent=$("<div />").addClass("panel-content-accordion"),accordion=$("<div />").width(250).addClass("panel-accordion");return accordion=accordion.append(panelAccordionContent),accordion},onOptionChanged:()=>{let buttonPanel=$(".buttonPanel");buttonPanel.hasClass("panelOpened")?buttonPanel.removeClass("panelOpened"):buttonPanel.addClass("panelOpened")}}).dxDrawer("instance"),LOADPANEL=$("#loadpanel").dxLoadPanel({shadingColor:"rgba(0,0,0,0.4)",position:{of:"#drawer"},height:"100vh",width:"100vw",visible:!1,showIndicator:!0,showPane:!0,shading:!0,hideOnOutsideClick:!1}).dxLoadPanel("instance");LOADPANEL.show();const SCHEDULER=$("#scheduler").dxScheduler({height:"100vh",useDropDownViewSwitcher:!0,dataSource:APPOINTMENT_SOURCE,adaptivityEnabled:!1,showAllDayPanel:!1,showCurrentTimeIndicator:!1,firstDayOfWeek:1,currentView:"semaine",crossScrollingEnabled:!1,dateSerializationFormat:"yyyy/MM/dd HH:mm:ss",groupByDate:!0,startDayHour:8,endDayHour:18.5,allowDragging:isDrag,groups:["equipeID"],editing:{allowDragging:isDrag,allowAdding:!0},views:[{type:"workWeek",name:"semaine"}],resources:[{key:"equipeID",fieldExpr:"equipeID",allowMultiple:!1,dataSource:[getDataTeams([],new Date)],label:"Equipe"},{fieldExpr:"salarieID",allowMultiple:!0,dataSource:SALARIE_STORE,label:"Salarié"},{fieldExpr:"statut",label:"Statut",dataSource:[{text:"Rendez-vous"},{text:"Message"},{text:"Non appelé"},{text:"Défaut"}]}],appointmentDragging:{group:"dragging",onRemove:e=>{e.component.deleteAppointment(e.itemData),createItemElement(e.itemData,$(`#list${e.itemData.devis.typeID}`)),$(`.sem-${getWeekNumber(SCHEDULER.option("currentDate"))}`).css("display","block")},onAdd:e=>{e.itemData.salarieID=getSalarieHereDefautEquip(new Date(e.itemData.startDate),e.itemData.equipeID),e.component.addAppointment(e.itemData),e.itemElement.remove()},onDragMove:e=>{let hoverCell=$(".dx-scheduler-date-table-droppable-cell");isDrag=!hoverCell.hasClass("dx-template-chome")},onDragEnd:e=>{e.cancel=!1===isDrag}},onAppointmentRendered:()=>{widthAppointment()},onAppointmentUpdated:e=>{e.component.repaint(),e.component.on([{repaint:afterRepaint()}])},onAppointmentUpdating:e=>{e.oldData.equipeID==e.newData.equipeID&&new Date(e.oldData.startDate).getDay()==new Date(e.newData.startDate).getDay()||(e.newData.salarieID=getSalarieHereDefautEquip(new Date(e.newData.startDate),e.newData.equipeID))},timeCellTemplate:(data,index,element)=>{element.text(data.text).css({color:"#469f11",height:cellHeight()})},appointmentTemplate:e=>{let startHour=new Date(e.appointmentData.startDate).toLocaleTimeString(),endHour=new Date(e.appointmentData.endDate).toLocaleTimeString(),border,statut,sal=e.appointmentData.salarieID;switch(e.appointmentData.statut){case"Rendez-vous":border="rdv";break;case"Message":border="mes";break;case"Non appelé":border="na";break;default:border="def"}statut=void 0===e.appointmentData.statut?"":e.appointmentData.statut;let wrapper=$("<div />").addClass(["app-content",`${border}`]),text=$("<div />").html(`${e.appointmentData.devis.text}`).addClass("app-text"),hour=$("<div />").html(`${startHour.slice(0,-3)} - ${endHour.slice(0,-3)}`).addClass("app-hour"),stat=$("<div />").html(`${statut}`).addClass("app-statut"),icon=$("<div />").addClass("member");return wrapper.append([text,hour,stat,icon]),$.each(sal,()=>{$("<i />").addClass("dx-icon user-icon dx-icon-user").appendTo(icon)}),wrapper},dataCellTemplate:(cellData,index,container)=>{container.css("height",cellHeight());let cellTime=cellData.startDate.getTime(),cellEquipe=cellData.groups.equipeID;PARAM_STORE.load().done(data=>{for(let[i,value]of data.entries()){const hours=`${cellData.startDate.getHours()}:${cellData.startDate.getMinutes()}:00`;hours>=`${value.pause.from}:00`&&hours<`${value.pause.to}:00`&&container.addClass("dx-template-Pose")}}),OFFICE_STORE.load().done(data=>{for(let[i,value]of data.entries()){let officeStart=new Date(data[i].startDate),officeEnd;switch(data[i].periodeID){case 1:officeStart=officeStart.getTime()+288e5,officeEnd=officeStart+144e5;break;case 2:officeStart=officeStart.getTime()+468e5,officeEnd=officeStart+18e6;break;case 3:officeStart=officeStart.getTime()+288e5,officeEnd=officeStart+432e5}officeStart<=cellTime&&officeEnd>=cellTime&&3==cellEquipe&&container.addClass("dx-template-Office")}}),CHOME_STORE.load().done(data=>{for(let[i,value]of data.entries()){let startDate=new Date(data[i].startDate),endDate=new Date(data[i].endDate);startDate.getTime()<=cellTime&&endDate.getTime()>=cellTime&&container.addClass("dx-template-chome")}})},appointmentTooltipTemplate:e=>{let startHour=new Date(e.appointmentData.startDate).toLocaleTimeString(),endHour=new Date(e.appointmentData.endDate).toLocaleTimeString(),container=$("<div />"),contentText=$("<div />").text(e.appointmentData.devis.text).appendTo(container),contentHour=$("<div />").text(`${startHour.slice(0,-3)} - ${endHour.slice(0,-3)}`).appendTo(container);return container},onAppointmentFormOpening:e=>{const appStartDate=new Date(e.appointmentData.startDate).getTime(),appEndDate=new Date(e.appointmentData.endDate).getTime();CHOME_STORE.load().done(data=>{for(let[i,value]of data.entries()){let startDate=new Date(data[i].startDate),endDate=new Date(data[i].endDate);startDate.getTime()<=appStartDate&&endDate.getTime()>=appEndDate&&(e.cancel=!0,createToast(ALERT_APPOINTMENT_DISABLE))}}),e.form.option({labelMode:"floating",colCountByScreen:{lg:1,sm:1},items:itemsAppointmentForm(e)})},onOptionChanged:e=>{if("currentDate"===e.name){let currentDate=SCHEDULER.option("currentDate");LOADPANEL.option("visible",!0),popupOption&&"hoursOffice-popup"==popupOption._customWrapperClass&&popupOption.resetOption("contentTemplate"),createOptionTeams(),SCHEDULER.option("resources[0].dataSource",getDataTeams(PARAM_STORE._array[0].teams,currentDate)),getDataAppointmentFM(currentDate),getDataAnnuelFM(getParamAnnuel(currentDate)),$(".itemSem").css("display","none"),$(`.sem-${getWeekNumber(currentDate)}`).css("display","block"),$("#button-sem .dx-button-text").text(getWeekNumber(currentDate)),SCHEDULER.repaint(),SCHEDULER.on([{repaint:afterRepaint()}]),queryToFM(new queryFM("save_date",SCHEDULER.option("currentDate"),0))}if("groupByDate"===e.name){let currentDate=SCHEDULER.option("currentDate");$("#button-sem .dx-button-text").text(getWeekNumber(currentDate))}},onAppointmentContextMenu:e=>{let salarieHere;3==e.appointmentData.equipeID?(salarieHere=getSalarieHere(e.appointmentData.startDate,e.appointmentData.equipeID),salarieHere=salarieHere.filter(data=>data.id==salOfficer())):salarieHere=getSalarieHere(e.appointmentData.startDate,e.appointmentData.equipeID),$.each(salarieHere,(i,item)=>{let salarieId=salarieHere[i].id;-1!=$.inArray(salarieId,e.appointmentData.salarieID)?item.checked=!0:item.checked=!1,item.onSelectionChanged=salAppointment,item.onItemClick=salAppointment,item.text=salarieHere[i].prenom});let itemMenuDetail=appointmentContextMenuItems.find(e=>"Détail"===e.text),itemMenuSdc=appointmentContextMenuItems.find(e=>"Suivi de chantier"===e.text),itemMenuFiche=appointmentContextMenuItems.find(e=>"Fiche travaux"===e.text),itemMenuSal=appointmentContextMenuItems.find(e=>"Salarié"===e.text);itemMenuSal.items=[],$.each(salarieHere,(i,data)=>{itemMenuSal.items.push(data)}),e.appointmentData.devis.dvs_ref?itemMenuDetail.disabled=!1:itemMenuDetail.disabled=!0,e.appointmentData.devis.dvs_ref?itemMenuFiche.disabled=!1:itemMenuFiche.disabled=!0,updateContextMenu(!1,appointmentContextMenuItems,getAppointmentMenuTemplate,onItemClick(e),".dx-scheduler-appointment")},onCellContextMenu:e=>{$(e.cellElement[0]).hasClass("dx-template-chome")?(cellContextMenuItems[0].disabled=!0,updateContextMenu(!1,cellContextMenuItems,getCellMenuTemplate,onItemClick(e),".dx-scheduler-date-table-cell")):(cellContextMenuItems[0].disabled=!1,updateContextMenu(!1,cellContextMenuItems,getCellMenuTemplate,onItemClick(e),".dx-scheduler-date-table-cell"))}}).dxScheduler("instance"),CONTEXT_MENU=$("#context-menu").dxContextMenu({width:200,dataSource:[],disabled:!0,target:".dx-scheduler-appointment"}).dxContextMenu("instance"),POPUP_WEEK={width:310,height:365,title:"Semaine",dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,wrapperAttr:{class:"sem-popup"},shading:!0,shadingColor:"#00000050",container:".dx-viewport",contentTemplate:elem=>{const WRAPPER_WEEK_POPUP=$("<div />").addClass("wrapper-popup-week"),WRAPPER_YEAR_SELECTER=$("<div/>").appendTo(WRAPPER_WEEK_POPUP).addClass("year-select"),YEAR_SELECTER=$("<div />").dxTextBox({name:"select-Year",value:new Date(getDate()).getFullYear(),width:200,buttons:[{location:"after",name:"prev",options:{icon:"chevronright",onClick:()=>{let yearSelecter=YEAR_SELECTER.dxTextBox("instance");yearSelecter.option("value",yearSelecter.option("value")+1)}}},{location:"before",name:"next",options:{icon:"chevronleft",onClick:()=>{let yearSelecter=YEAR_SELECTER.dxTextBox("instance");yearSelecter.option("value",yearSelecter.option("value")-1)}}}]});YEAR_SELECTER.appendTo(WRAPPER_YEAR_SELECTER);const WRAPPER_TABLE_NUM_WEEK=$("<div />").addClass("wrapper-sem").appendTo(WRAPPER_WEEK_POPUP);for(let i=1;i<=53;i++){const BUTTON_NUM_WEEK=$("<div />").addClass(`num-sem num-sem${i}`).dxButton({stylingMode:"outlined",elementAttr:{sem:i},text:i,type:"normal",width:32,height:32,onClick:e=>{let elem=YEAR_SELECTER.dxTextBox("instance");goWeek(parseInt(e.element[0].attributes.sem.value),elem.option("value")),popupOption.hide()}});WRAPPER_TABLE_NUM_WEEK.append(BUTTON_NUM_WEEK)}return WRAPPER_WEEK_POPUP},position:{my:"right top",at:"left top",of:".sem",offset:"0 10"}},POPUP_OFFICE_OPTION={width:260,height:320,showTitle:!0,title:"heures de bureau",showCloseButton:!0,dragEnabled:!1,closeOnOutsideClick:!0,shading:!0,shadingColor:"#00000050",container:".dx-viewport",wrapperAttr:{class:"hoursOffice-popup"},position:{my:"left center",at:"right center",of:".buttonOffice",offset:"10 20"},contentTemplate:()=>{const START_DATE=SCHEDULER.getStartViewDate(),WRAPPER_POPUP_OFFICE_OPTION=$("<div />").addClass("wrapper-hoursOffice-popup");let periodeOffice;return $(".dx-scheduler-header-panel-cell").each((i,elem)=>{const DAY=new Date(START_DATE);DAY.setDate(START_DATE.getDate()+i);const NEW_DAY=getDateFormatAAAAMD(DAY);OFFICE_SOURCE.filter("startDate",NEW_DAY),OFFICE_SOURCE.load().done(result=>{periodeOffice=0!=result.length?result[0].periodeID:0});const DAY_TEXT=$(elem).children().clone(),WRAPPER_DAY=$("<div />").addClass("contener-jourOffice").html(DAY_TEXT),WRAPPER_SELECTOR=$("<div />").addClass(`contener-select select-num-${i}`).data("day",NEW_DAY).dxSelectBox({dataSource:[{periode:"Journée",periodeID:3},{periode:"Matin",periodeID:1},{periode:"Après-midi",periodeID:2}],displayExpr:"periode",valueExpr:"periodeID",value:periodeOffice,width:"150px",showClearButton:!0,onValueChanged:e=>{updateHoursOffice(e)}});WRAPPER_DAY.appendTo(WRAPPER_POPUP_OFFICE_OPTION),WRAPPER_SELECTOR.appendTo(WRAPPER_POPUP_OFFICE_OPTION)}),WRAPPER_POPUP_OFFICE_OPTION},toolbarItems:[{visible:!1}]},POPUP_SALARIE_ABSENCE_OPTION={width:610,height:435,title:"Absence des salariés",dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"#00000050",container:".dx-viewport",wrapperAttr:{class:"grid-salAbsence-popup"},position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{const WRAPPER_SALARIE_ABSENCE=$("<div />").addClass("wrapper-grid-salAbs-popup"),GRID_SALARIE_ABSENCE=WRAPPER_SALARIE_ABSENCE.dxDataGrid({elementAttr:{id:"grid-salarie-absence"},dataSource:ABSENCE_STORE,scrolling:{mode:"infinite"},height:"350px",showColumnLines:!0,showBorders:!0,headerFilter:{visible:!1},columns:[{dataField:"salarieID",width:150,caption:"Nom",setCellValue:(rowData,value)=>{rowData.salarieID=value},lookup:{dataSource:SALARIE_STORE,valueExpr:"id",displayExpr:"prenom"}},{dataField:"startDate",dataType:"datetime",caption:"Date de début",width:170,sortOrder:"desc"},{dataField:"endDate",dataType:"datetime",caption:"Date de fin",width:170}],editing:{mode:"form",allowUpdating:!0,allowDeleting:!0,allowAdding:!0}}).dxDataGrid("instance");return WRAPPER_SALARIE_ABSENCE},toolbarItems:[{visible:!1}]},POPUP_ADD_SALARIE_OPTION={width:500,height:350,title:"ajouter un salarié",dragEnabled:!1,closeOnOutsideClick:!1,showCloseButton:!1,shading:!0,shadingColor:"#00000050",container:".dx-viewport",wrapperAttr:{class:"addSal-popup"},position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{const WRAPPER_ADD_SALARIE=$("<div />").addClass("wrapper-AddSall-popup"),WRAPPER_FORM_ADD_SALARIE=$("<div />").addClass("form-addSal").appendTo(WRAPPER_ADD_SALARIE),WRAPPER_TOOLBAR_ADD_SALARIE=$("<div />").addClass("toolbar-addSal").appendTo(WRAPPER_ADD_SALARIE),FORM_ADD_SALARIE=WRAPPER_FORM_ADD_SALARIE.dxForm({readOnly:!1,showColonAfterLabel:!0,height:"auto",minColWidth:300,colCount:2,showValidationSummary:!1,validationGroup:"formAddSal",labelMode:"floating",labelLocation:"left",items:[{name:"nom",dataField:"nom",label:{text:"Nom"},editorOptions:{value:"",disabled:!1},validationRules:[{type:"required",message:"le nom est requis"}]},{dataField:"prenom",label:{text:"prénom"},editorOptions:{value:"",disabled:!1},validationRules:[{type:"required",message:"le prénom est requis"}]},{dataField:"ctr",label:{text:"Contrat"},editorType:"dxSelectBox",colSpan:2,editorOptions:{items:["partage","CDD","CDI"],searchEnabled:!0,value:"",onValueChanged:data=>{"CDI"!==data.value?$(".ctr-date").show():($(".ctr-date").hide(),FORM_ADD_SALARIE.option("items[3].editorOptions.value","01/01/2000"),FORM_ADD_SALARIE.option("items[4].editorOptions.value","01/01/2100"))}},validationRules:[{type:"required",message:"le type de contrat est requis"}]},{dataField:"startDate",cssClass:"ctr-date startDate",label:{text:"date de début de contrat"},editorType:"dxDateBox",editorOptions:{value:"",width:"100%"},validationRules:[{type:"required",message:"la date de début est requise"}]},{dataField:"endDate",cssClass:"ctr-date endDate",label:{text:"date de fin de contrat"},editorType:"dxDateBox",editorOptions:{value:"",width:"100%"},validationRules:[{type:"required",message:"la date de fin est requise"}]},{dataField:"actif",editorType:"dxCheckBox",label:{text:"Actif"},editorOptions:{value:!0}}]}).dxForm("instance"),TOOLBAR_ADD_SALARIE=WRAPPER_TOOLBAR_ADD_SALARIE.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"ok",validationGroup:"formAddSal",onClick:function validate(params){let valid;if(!0===params.validationGroup.validate().isValid){let newData=Object.defineProperty(FORM_ADD_SALARIE._options._optionManager._options.formData,"id",{value:create_UUID()});newData=Object.defineProperty(FORM_ADD_SALARIE._options._optionManager._options.formData,"actif",{value:1}),SALARIE_STORE.insert(newData),popupOption.hide()}}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",onClick:()=>{popupOption.hide()}}}]});return WRAPPER_ADD_SALARIE},toolbarItems:[{visible:!1}]},POPUP_SHOW_SALARIE_OPTION={width:475,height:520,title:"Salariés",dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"#00000050",container:".dx-viewport",wrapperAttr:{class:"grid-sal-popup"},position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{const WRAPPER_SHOW_SALARIE=$("<div />").addClass("wrapper-template-popup"),WRAPPER_GRID_SHOW_SALARIE=$("<div />").addClass("grid-showSal").appendTo(WRAPPER_SHOW_SALARIE),WRAPPER_TOOLBAR_SHOW_SALARIE=$("<div />").addClass("toolbar-showSal").appendTo(WRAPPER_SHOW_SALARIE),GRID_SHOW_SALARIE=WRAPPER_GRID_SHOW_SALARIE.dxDataGrid({elementAttr:{id:"grid-salarie"},dataSource:SALARIE_STORE,filterValue:["actif",1],scrolling:{mode:"infinite"},height:"420px",showColumnLines:!0,showBorders:!0,headerFilter:{visible:!1},columns:[{dataField:"nom",dataType:"string",width:130,caption:"Nom"},{dataField:"prenom",dataType:"string",width:130,caption:"Prénom"},{dataField:"ctr",dataType:"string",caption:"Contrat",width:100},{dataField:"actif",dataType:"number",caption:"Actif",visible:!1}],editing:{mode:"form",allowUpdating:!0,allowDeleting:!0,allowAdding:!1,form:{colCount:1,items:[{itemType:"group",colCount:2,items:[{dataField:"nom"},{dataField:"prenom"},{dataField:"ctr"},{dataField:"actif",editorType:"dxSwitch",editorOptions:{dataType:"number"}}]}]}},onRowUpdating:e=>{let actif;actif=e.newData.actif?1:0,Object.defineProperty(e.newData,"actif",{value:actif})}}).dxDataGrid("instance"),TOOLBAR_SHOW_SALARIE=WRAPPER_TOOLBAR_SHOW_SALARIE.dxToolbar({items:[{location:"before",widget:"dxCheckBox",options:{text:"Actif",value:1,onValueChanged:e=>{!0===e.value?GRID_SHOW_SALARIE.option({filterValue:["actif",1]}):GRID_SHOW_SALARIE.option({filterValue:null})}}}]});return WRAPPER_SHOW_SALARIE},toolbarItems:[{visible:!1}]},POPUP_ADD_TEAM_OPTION={width:500,height:320,title:"ajouter une équipe",dragEnabled:!1,closeOnOutsideClick:!1,showCloseButton:!1,wrapperAttr:{class:"addEquipe-popup"},shading:!0,shadingColor:"#00000050",container:".dx-viewport",position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{let salarie;SALARIE_SOURCE.filter("actif",1),SALARIE_SOURCE.load().done(result=>{salarie=result});const WRAPPER_ADD_TEAM=$("<div />").addClass("wrapper-AddEquipe-popup"),WRAPPER_FORM_ADD_TEAM=$("<div />").addClass("form-addSal").appendTo(WRAPPER_ADD_TEAM),WRAPPER_TOOLBAR_ADD_TEAM=$("<div />").addClass("toolbar-addSal").appendTo(WRAPPER_ADD_TEAM),FORM_ADD_TEAM=WRAPPER_FORM_ADD_TEAM.dxForm({name:"FORM_ADD_TEAM",readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:300,height:220,colCount:2,showValidationSummary:!1,validationGroup:"formAddEquip",items:[{dataField:"text",label:{text:"nom de l'équipe"},editorOptions:{colSpan:2,value:"",disabled:!1},validationRules:[{type:"required",message:"le nom d'équipe est requis"}]},{itemType:"empty"},{dataField:"startDate",label:{text:"date de début"},editorType:"dxDateBox",editorOptions:{value:"",width:"100%"},validationRules:[{type:"required",message:"la date de début est requise"}]},{dataField:"endDate",label:{text:"date de fin"},editorType:"dxDateBox",editorOptions:{value:"",width:"100%"},validationRules:[{type:"required",message:"la date de fin est requise"}]},{dataField:"defautSalId",label:{text:"salarié par défaut pour cette équipe"},editorType:"dxTagBox",editorOptions:{dataSource:salarie,displayExpr:"prenom",valueExpr:"id",showSelectionControls:!0,applyValueMode:"useButtons"},validationRules:[{type:"required",message:"vous devez selectionner au moin 1 salarié"}]},{dataField:"color",label:{text:"couleur"},editorType:"dxColorBox",editorOptions:{applyButtonText:"ok"},validationRules:[{type:"required",message:"Choisissez une couleur"}]}]}).dxForm("instance"),TOOLBAR_ADD_TEAM=WRAPPER_TOOLBAR_ADD_TEAM.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"ok",validationGroup:"formAddEquip",onClick:function validate(params){const VALID=params.validationGroup.validate();let newData;!0===VALID.isValid&&(newData=Object.defineProperty(FORM_ADD_TEAM._options._optionManager._options.formData,"id",{value:create_UUID()}),TEAMS_STORE.insert(newData),createOptionTeams(),popupOption.hide())}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",onClick:e=>{popupOption.hide()}}}]});return WRAPPER_ADD_TEAM},toolbarItems:[{visible:!1}]},POPUP_SHOW_TEAMS_OPTION={width:700,height:550,title:"Voir les équipes",dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,wrapperAttr:{class:"grid-salAbsence-popup"},shading:!0,shadingColor:"#00000050",container:".dx-viewport",position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{const WRAPPER_SHOW_TEAMS=$("<div />").addClass("wrapper-grid-showEquip-popup"),GRID_SHOW_TEAMS=WRAPPER_SHOW_TEAMS.dxDataGrid({dataSource:TEAMS_STORE,height:"460px",showColumnLines:!0,showBorders:!0,headerFilter:{visible:!1},editing:{mode:"form",allowUpdating:!0,allowDeleting:!0,allowAdding:!1},onRowRemoved:team=>{let array=PARAM_STORE._array[0].teams;array=array.filter(e=>e!==team.key),PARAM_STORE.update(PARAM_STORE._array[0].id,{teams:array})},columns:[{dataField:"text",width:110,caption:"Nom"},{dataField:"startDate",dataType:"datetime",caption:"Date de début",width:110,sortOrder:"desc"},{dataField:"endDate",dataType:"datetime",caption:"Date de fin",width:110},{dataField:"defautSalId",width:150,caption:"Salariés par défaut",lookup:{dataSource:SALARIE_STORE,valueExpr:"id",displayExpr:"prenom"},cellTemplate:(container,options)=>{const NO_BREAK_SPACE=" ",TEXT=(options.value||[]).map(element=>options.column.lookup.calculateCellValue(element)).join(", ");container.text(TEXT||" ").attr("title",TEXT)},editCellTemplate:tagBoxEquipeDefautSalId},{dataField:"color",width:100,caption:"Couleur",lookup:{dataSource:SALARIE_STORE,valueExpr:"id",displayExpr:"prenom"},cellTemplate:(container,options)=>{const COLOR=$("<div />").css("backgroundColor",options.value).addClass("color-equipe");container.append(COLOR)},editCellTemplate:colorPickerEquipe}]}).dxDataGrid("instance");return WRAPPER_SHOW_TEAMS},toolbarItems:[{visible:!1}]},POPUP_GRID_UNWORKINGDAY_OPTION={width:455,height:480,title:"Jours chomés",dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,wrapperAttr:{class:"grid-unworkedDay-popup"},shading:!0,shadingColor:"#00000050",container:".dx-viewport",position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{const WRAPPER_GRID_UNWORKINGDAY=$("<div />").addClass("wrapper-grid-salAbs-popup"),GRID_UNWORKINGDAY=WRAPPER_GRID_UNWORKINGDAY.dxDataGrid({dataSource:CHOME_STORE,scrolling:{mode:"infinite"},height:"400px",showColumnLines:!0,showBorders:!0,headerFilter:{visible:!0},columns:[{dataField:"startDate",dataType:"date",caption:"Date de début",width:170,sortOrder:"desc"},{dataField:"endDate",dataType:"date",caption:"Date de fin",width:170}],editing:{mode:"form",allowUpdating:!0,allowDeleting:!0,allowAdding:!0},onRowUpdated:()=>{SCHEDULER.repaint(),SCHEDULER.on([{repaint:afterRepaint()}])},onRowInserted:()=>{SCHEDULER.repaint(),SCHEDULER.on([{repaint:afterRepaint()}])},onRowRemoved:()=>{SCHEDULER.repaint(),SCHEDULER.on([{repaint:afterRepaint()}])}});return WRAPPER_GRID_UNWORKINGDAY},toolbarItems:[{visible:!1}]},POPUP_SEARCH={width:455,height:480,title:"Recherche",dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,wrapperAttr:{class:"grid-search-popup"},shading:!0,shadingColor:"#00000050",container:".dx-viewport",position:{my:"center",at:"center",of:"window"},contentTemplate:()=>{const WRAPPER_LIST_SEARCH=$("<div />").addClass("wrapper-grid-search-popup"),LIST_SEARCH=WRAPPER_LIST_SEARCH.dxList({dataSource:APPOINTMENT_LIST_STORE,scrolling:{mode:"infinite"},height:"400px",itemTemplate:function(data,_,element){element.append($("<b>").text(data.nom),$("<br />"),$("<p>").text(data.devis).css("margin",0),$("<p>").text(data.date).css("margin",0))},searchEnabled:!0,searchExpr:["nom","devis"],searchMode:"contains",pageLoadMode:"scrollBottom",onItemClick(e){const DAY=getDateFormatDDMMAAAA_AAAAMD(e.itemData.date);SCHEDULER.option("currentDate",new Date(DAY)),popupOption.hide()}});return WRAPPER_LIST_SEARCH},toolbarItems:[{visible:!1}]},ACCORDION=$(".panel-content-accordion").dxAccordion({dataSource:[{title:"Options",id:3},{title:"Ponctuel",id:2},{title:"Annuel",id:1}],animationDuration:300,collapsible:!0,multiple:!1,width:250,height:"auto",deferRendering:!1,itemTitleTemplate:(itemData,itemIndex,itemElement)=>{const TITLE=$("<span />").text(itemData.title);TITLE.appendTo(itemElement)},itemTemplate:(itemData,itemIndex,itemElement)=>{let height_wrapper=W_HEIGHT-150>750?750:W_HEIGHT-150;const WRAPPER_LISTE=$("<div />").addClass("listContent").height(height_wrapper),WRAPPER_DRAGGABLE_ITEMS=$("<div />").addClass("list scroll").attr("id",`list${itemData.id}`);switch(WRAPPER_LISTE.append(WRAPPER_DRAGGABLE_ITEMS),itemElement.append(WRAPPER_LISTE),itemIndex){case 1:PONCTUEL_SOURCE.load().done(result=>{createList(result)});break;case 2:let d=SCHEDULER.option("currentDate");d=d.getFullYear(),ANNUEL_SOURCE.load().done(result=>{createList(result)});break;default:const OPTION_SEARCH=$("<div />").addClass("option search-option");$("#list3").append(OPTION_SEARCH),$("#list3").append($("<div />").addClass("option groupChanged")),createOptionGroupByDate();const TEAMS_SWITCH=$("<div />").addClass("option equipChanged");$("#list3").append(TEAMS_SWITCH),TEAMS_SWITCH.append($("<span />").addClass("option-label").text("afficher les équipes...")),TEAMS_SWITCH.append($("<div />").addClass("switchEquip group-option").attr("id","switch-teams"));const OPTION_OFFICE=$("<div />").addClass("option groupe-option");OPTION_OFFICE.append($("<span />").addClass("option-label").text("Bureau")),$("#list3").append(OPTION_OFFICE);const OPTION_SALARIE=$("<div />").addClass("option groupe-option");OPTION_SALARIE.append($("<span />").addClass("option-label").text("Salariés")),$("#list3").append(OPTION_SALARIE);const OPTION_TEAMS=$("<div />").addClass("option groupe-option");OPTION_TEAMS.append($("<span />").addClass("option-label").text("Equipe")),$("#list3").append(OPTION_TEAMS);let OPTION_UNWORKING_DAY=$("<div />").addClass("option groupe-option");OPTION_UNWORKING_DAY.append($("<span />").addClass("option-label").text("Jour non travaillé")),$("#list3").append(OPTION_UNWORKING_DAY);const OPTION_ACTION=$("<div />").addClass("option groupe-option action");OPTION_ACTION.append($("<span />").addClass("option-label").text("Actions")),$("#list3").append(OPTION_ACTION);const BUTTON_OPTION=[{group:OPTION_SEARCH,text:"Rechercher",icon:"search",className:"buttonSearch",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_SEARCH}}}},{group:OPTION_OFFICE,text:"Gerer les heures de Bureau",icon:"ja-office",className:"buttonOffice",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_OFFICE_OPTION}}}},{group:OPTION_SALARIE,text:"Gérer les abscences",icon:"ja-abs",className:"buttonAbsence",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_SALARIE_ABSENCE_OPTION}}}},{group:OPTION_SALARIE,text:"Ajouter un salarié",icon:"ja-add-sal",className:"buttonAddSalarie",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_ADD_SALARIE_OPTION}}}},{group:OPTION_SALARIE,text:"Voir les salariés",icon:"ja-show-sal",className:"buttonShowSalarie",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_SHOW_SALARIE_OPTION}}}},{group:OPTION_TEAMS,text:"Ajouter une équipe",icon:"ja-add-team",className:"buttonShowEquipe",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_ADD_TEAM_OPTION}}}},{group:OPTION_TEAMS,text:"Voir les équipes",icon:"ja-show-team",className:"buttonShowEquipe",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_SHOW_TEAMS_OPTION}}}},{group:OPTION_UNWORKING_DAY,text:"Jour non travaillé",icon:"ja-calendar",className:"buttonUnworkedDay",event:{intern:{name:createPopupOption,param:{contentOption:POPUP_GRID_UNWORKINGDAY_OPTION}}}},{group:OPTION_ACTION,text:"Actualiser",icon:"ja-reload",event:{fmScript:{name:"Actualiser",param:getDate}}},{group:OPTION_ACTION,text:"Fiche travaux",icon:"ja-export",event:{fmScript:{name:"Creation_fiche_chantier",param:ficheTravSemaine}}},{group:OPTION_ACTION,text:"Reconnexion",icon:"ja-admin",event:{fmScript:{name:"Reconnexion"}}}];$.each(BUTTON_OPTION,(function(key,value){createButtonOption(value)}))}}}).dxAccordion("instance"),SCROLL_VIEW_LISTE=$(".listContent").dxScrollView({useNative:!1,showScrollbar:"onScroll"}).dxScrollView("instance"),ALERT_TEAM={message:"vous devez sélectionner au moin une équipe",type:"error"},ALERT_APPOINTMENT_DISABLE={message:"vous ne pouvez pas créer d'évenement pour cette date.",type:"warning"},ALERT_SMS_SUCCESS={message:"le SMS a bien été envoyé",type:"success"};function start(){intervalId=setInterval(()=>{queryToFM(new queryFM("getNotification","",1))},5e3)}function afterListClientInStore(){SCHEDULER.repaint(),SCHEDULER.on([{initialized:afterRepaint()}])}function afterTeamsInStore(){createOptionTeams(),SCHEDULER.option("resources[0].dataSource",getDataTeams(PARAM_STORE._array[0].teams,SCHEDULER.option("currentDate")))}function initParam(){1==PARAM_STORE._array[0].drawer&&DRAWER.option("opened",!0),0!=PARAM_STORE._array[0].currentDate.length&&(SCHEDULER.option("currentDate",new Date(PARAM_STORE._array[0].currentDate)),PARAM_STORE.update(PARAM_STORE._array[0].id,{currentDate:""}))}function salOfficer(){let office;return SALARIE_STORE.load().done(e=>{const CHEF=e.filter(sal=>1==sal.bureau);office=0===CHEF.length?"":CHEF[0].id}),office}function widthAppointment(){const WIDTH_CELL=$(".dx-scheduler-date-table-cell").width();$(".dx-scheduler-appointment-vertical").width(WIDTH_CELL+1.6)}function cellHeight(){const HEIGHT_CELL=(W_HEIGHT-116)/21-1;return HEIGHT_CELL}function afterRepaint(){$(".dx-scheduler-view-switcher").remove(),$(".dx-scheduler-view-switcher-label").remove(),createSemContainer(),initWeekNumber(),initParam(),LOADPANEL.hide()}function itemsAppointmentForm(e){const ITEMS_APPOINTMENT_FORM=[{itemType:"group",name:"title",colCount:3,items:[]},{itemType:"group",name:"date",colCount:2,items:[{dataField:"startDate",label:{text:"Date de début",visible:!1},editorType:"dxDateBox",editorOptions:{placeholder:"date de début",width:"100%",type:"datetime",disabledDates:args=>{const CHOME=disableDate(args),RESULT="month"===args.view&&(CHOME.weekend||CHOME.chome);return RESULT},onValueChanged:date=>{e.form.updateData("endDate",dateFinActualise(date.value,e))}}},{name:"endDate",dataField:"endDate",label:{text:"Date de fin",visible:!1},editorType:"dxDateBox",editorOptions:{placeholder:"date de fin",width:"100%",type:"datetime",disabledDates:args=>{const CHOME=disableDate(args),RESULT="month"===args.view&&(CHOME.weekend||CHOME.chome);return RESULT}}}]},{itemType:"group",name:"description",colCount:1,items:[{name:"description",dataField:"devis.description",label:{text:"Description",visible:!1},colSpan:1,editorType:"dxTextArea",editorOptions:{displayExpr:"text",elementAttr:{id:"description"}}},{name:"observation",dataField:"observation",label:{text:"Observation",visible:!1},colSpan:1,editorType:"dxTextArea",editorOptions:{displayExpr:"text",elementAttr:{id:"observation"}}},{name:"clt_ref",dataField:"devis.client.clt_ref",label:{text:"clt_ref",visible:!1},colSpan:2,editorType:"dxTextArea",editorOptions:{displayExpr:"text",elementAttr:{id:"clt_ref"},visible:!1}}]},{itemType:"group",cssClass:"group-col-gap",name:"information",colCount:3,items:[{name:"statut",dataField:"statut",label:{visible:!1},editorType:"dxSelectBox",editorOptions:{visible:!(void 0===e.component._editAppointmentData||void 0!==e.component._editAppointmentData&void 0!==e.appointmentData.devis&void 0===e.appointmentData.devis.detail),placeholder:"Statut",dataSource:[{text:"Rendez-vous"},{text:"Message"},{text:"Non appelé"},{text:"Défaut"}],width:"100%",itemTemplate:itemData=>itemData.text,displayExpr:"text",value:void 0!==e.appointmentData.statut?e.appointmentData.statut:"Défaut",valueExpr:"text",onOpened:e=>{e.component._popup.option("width",180)}}},{name:"equipe",dataField:"equipeID",label:{text:"Equipe",visible:!1},editorType:"dxSelectBox",editorOptions:{visible:!(void 0===e.component._editAppointmentData||void 0!==e.component._editAppointmentData&void 0!==e.appointmentData.devis&void 0===e.appointmentData.devis.detail),width:"100%",placeholder:"Equipe",dataSource:TEAMS_STORE,displayExpr:"text",valueExpr:"id"}},{name:"salarie",dataField:"salarieID",label:{text:"Salariés",visible:!1},editorType:"dxTagBox",editorOptions:{visible:!(void 0===e.component._editAppointmentData||void 0!==e.component._editAppointmentData&void 0!==e.appointmentData.devis&void 0===e.appointmentData.devis.detail),placeholder:"Salariés",width:"100%",dataSource:getSalarieHere(e.appointmentData.startDate,e.appointmentData.equipeID),value:new equipDefaultSalID(e.appointmentData.equipeID,e.appointmentData.salarieID),displayExpr:"prenom",valueExpr:"id",showSelectionControls:!0,onOpened:e=>{e.component._popup.option("width",230)}}}]}];if(void 0!==e.component._editAppointmentData){let title={name:"Titre_dvs",dataField:"devis.text",label:{text:"Titre",visible:!1},colSpan:3,editorType:"dxTextBox",editorOptions:{disabled:!0,displayExpr:"text",elementAttr:{id:"nom_dvs"},visible:!0}};ITEMS_APPOINTMENT_FORM[0].items.push(title)}else{let title={name:"titre_select",dataField:"devis.text",label:{text:"Titre",visible:!1},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:CLIENT_SOURCE,valueExpr:"clt_nom",displayExpr:"clt_nom",itemTemplate:function(itemData,itemIndex,itemElement){return $("<div />").append($("<div />").text(`${itemData.clt_nom}`).css({display:"inline-block","min-width":"50%","margin-right":"15px"}),$("<div />").text(`${itemData.clt_ville}`).css({display:"inline-block","text-align":"left"}))},elementAttr:{id:"nom"},width:"100%",type:"text",searchEnabled:!0,searchMode:"startswith",minSearchLength:1,acceptCustomValue:!0,visible:!0,onItemClick:data=>{data.itemData&&(getDataClient(data.itemData.clt_ref),setDataClient=val=>{textClt=`${JSON.parse(val).adres}\n${JSON.parse(val).ville}\n${JSON.parse(val).tel1}\n${JSON.parse(val).tel2}`,e.form.option("items[2].items[0].editorOptions.value",textClt),e.form.option("items[2].items[2].editorOptions.value",data.itemData.clt_ref)})},onCustomItemCreating:data=>{if(!data.text||$(".dx-dialog").length)return void(data.customItem=null);const cltRefs=CLIENT_STORE._array.map(item=>item.clt_ref),ref=Math.max.apply(null,cltRefs)+1,newItem={clt_nom:data.text,clt_ref:ref};data.customItem=CLIENT_SOURCE.store().insert(newItem).then(()=>msgCreateClient(newItem,e)).then(()=>CLIENT_SOURCE.load()).then(()=>newItem).catch(error=>{throw error})}},validationRules:[{type:"required",message:"le titre est requis"}]},buttonNewClient={name:"button_nouveau_client",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"nouveau client",type:"success",elementAttr:{class:"button-nouveau-client"},visible:!0,onClick:()=>{const cltRefs=CLIENT_STORE._array.map(item=>item.clt_ref),ref=Math.max.apply(null,cltRefs)+1,newItem={clt_nom:"",clt_ref:ref};CLIENT_SOURCE.store().insert(newItem),CLIENT_SOURCE.load(),msgCreateClient(newItem,e)}}};ITEMS_APPOINTMENT_FORM[0].items.push(title),ITEMS_APPOINTMENT_FORM[0].items.push(buttonNewClient),e.form.option("formData.statut","Rendez-vous")}if(void 0!==e.component._editAppointmentData){let groupButtonAction={itemType:"group",name:"button_action",cssClass:"group-col-gap",colCount:3,items:[{name:"button_contact",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"contacter",type:"success",elementAttr:{class:"button-contact"},onClick:()=>{contactClient(e)}}}]};if(ITEMS_APPOINTMENT_FORM.push(groupButtonAction),void 0===e.appointmentData.devis||void 0===e.appointmentData.devis.detail){let button_map={name:"button_map",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"map",type:"success",elementAttr:{class:"button-map"},visible:!0,onClick:()=>{queryToFM(new queryFM("map adresse",e.appointmentData.devis.client.clt_ref,0))}}};ITEMS_APPOINTMENT_FORM[4].items.push(button_map)}if(void 0!==e.appointmentData.devis&&void 0!==e.appointmentData.devis.detail){let button_detail={name:"button_detail",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"détail",type:"success",elementAttr:{class:"button-detail"},visible:!0,onClick:()=>{createPopupDevisInfo(e)}}};ITEMS_APPOINTMENT_FORM[4].items.push(button_detail);let button_ficheTrav={name:"button_ficheTrav",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"fiche travaux",type:"success",elementAttr:{class:"button-fiche-trav"},visible:!0,onClick:()=>{ficheTrav(e)}}};ITEMS_APPOINTMENT_FORM[4].items.push(button_ficheTrav);let button_suiviChantier={name:"button_suiviChantier",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"suivi de chantier",type:"success",elementAttr:{class:"button-fiche-trav"},visible:!0,onClick:()=>{createPopupTimeResult(e)}}};ITEMS_APPOINTMENT_FORM[4].items.push(button_suiviChantier)}}return ITEMS_APPOINTMENT_FORM}function getSalarieHere(j,teamID){let salariePresent,absenceData,officeData;return SALARIE_SOURCE.filter("actif",1),SALARIE_SOURCE.load().done(result=>{salariePresent=result}),ABSENCE_SOURCE.load().done(result=>{absenceData=result}),OFFICE_SOURCE.load().done(result=>{officeData=result}),j=new Date(j).getTime(),3!=teamID?($.each(absenceData,i=>{const START=absenceData[i].startDate,END=absenceData[i].endDate;new Date(START).getTime()<=j&&new Date(END).getTime()>=j&&(salariePresent=salariePresent.filter(data=>data.id!==absenceData[i].salarieID))}),$.each(officeData,i=>{const OFFICE_START=new Date(officeData[i].startDate);let start,end;switch(officeData[i].periodeID){case 1:start=OFFICE_START.getTime()+288e5,end=start+144e5;break;case 2:start=OFFICE_START.getTime()+468e5,end=start+18e6;break;case 3:start=OFFICE_START.getTime()+288e5,end=start+432e5}start<=j&&end>=j&&(salariePresent=salariePresent.filter(data=>data.id!==salOfficer()))})):(salariePresent=salariePresent.filter(data=>data.id==salOfficer()),$.each(absenceData,i=>{let start=absenceData[i].startDate,end=absenceData[i].endDate;new Date(start).getTime()<=j&&new Date(end).getTime()>=j&&(salariePresent=salariePresent.filter(data=>data.id!==absenceData[i].salarieID))})),salariePresent}function getSalarieHereDefautEquip(j,teamID){const TEAM=$.grep(TEAMS_STORE._array,e=>e.id===teamID),DEFAULT_SAL_ID=TEAM[0].defautSalId,SALARIE_HERE=getSalarieHere(j,teamID);let sal=[];return $.each(DEFAULT_SAL_ID,(y,val)=>{$.each(SALARIE_HERE,(i,data)=>{data.id===val&&sal.push(data.id)})}),sal}function updateHoursOffice(e){const DAY=e.element.data("day"),DAY_TIME=new Date(DAY).getTime();OFFICE_SOURCE.filter("startDate",DAY),OFFICE_SOURCE.load().done(result=>{0!=result.length&&null===e.value?OFFICE_STORE.remove(result[0].id):0!=result.length&&null!==e.value?OFFICE_STORE.update(result[0].id,{periodeID:e.value}):OFFICE_STORE.insert({startDate:DAY,periodeID:e.value}),SCHEDULER.repaint(),SCHEDULER.on([{repaint:afterRepaint()}])})}function getDataTeams(value,d){let j=new Date(d).getTime(),equipeShowInScheduler=[];return TEAMS_STORE._array.length>0?$.each(value,(i,val)=>{const TEAM=$.grep(TEAMS_STORE._array,e=>e.id===val);new Date(TEAM[0].startDate).getTime()<=j&&new Date(TEAM[0].endDate).getTime()>=j&&equipeShowInScheduler.push(TEAM[0])}):equipeShowInScheduler=[{id:"1"}],equipeShowInScheduler}function disableDate(args){let isChome;const Chome=$.grep(CHOME_STORE._array,e=>{const START_DATE=new Date(e.startDate),END_DATE=new Date(e.endDate);return args.date.getTime()>=START_DATE.getTime()&&args.date.getTime()<=END_DATE.getTime()-6e4});isChome=Chome.length>0;const DAY_WEEK=args.date.getDay(),WEEKEND=0===DAY_WEEK||6===DAY_WEEK,RESULT=new Object;return RESULT.chome=isChome,RESULT.weekend=WEEKEND,RESULT}function msgCreateClient(item,e){const MSG_CREATE_CLIENT=DevExpress.ui.dialog.confirm("Voulez vous créer un client dans l'application <i>jardin?</i>","Créer un client");MSG_CREATE_CLIENT.done(msg=>{msg&&createPopupAddClient(item,e)})}function dateFinActualise(date,e){let startDate=new Date(date),oldEndDate=new Date(e.appointmentData.endDate),oldStartDate=new Date(e.appointmentData.startDate),duration=oldEndDate.getTime()-oldStartDate.getTime(),endDate=new Date(startDate.valueOf()+duration);return endDate.getHours()>17&&endDate.setHours(17,0),endDate}function getDate(){return getDateFormatAAAAMD(SCHEDULER.option("currentDate"))}function initWeekNumber(){$("#button-sem .dx-button-text").text(getWeekNumber(SCHEDULER.option("currentDate")))}function createSemContainer(){const WRAPPER_WEEK=$("<div />").appendTo(".dx-scheduler-header .dx-toolbar-items-container .dx-toolbar-after").addClass("wrapper-sem"),BUTTON_LABEL=$("<div />").appendTo(WRAPPER_WEEK).addClass("sem-label").text("semaine"),WRAPPER_BUTTON=$("<div />").appendTo(WRAPPER_WEEK).attr({id:"button-sem",class:"sem"}),BUTTON_SEM=$("#button-sem").dxButton({stylingMode:"outlined",text:"0",type:"normal",width:36,onClick:()=>{createPopupOption({contentOption:POPUP_WEEK})}})}function dateStartEndCurrentSem(day){let dayS=new Date(day),dayE=new Date(dayS),d;d=0==day.getDay()?6:day.getDay()-1,dayS.setDate(day.getDate()-d),dayE.setDate(dayS.getDate()+6),dayS=getDateFormatAAAAMMDD(dayS),dayE=getDateFormatAAAAMMDD(dayE);class appointementDate{constructor(s,e){this.dateStart=s,this.dateEnd=e}}return result=new appointementDate(dayS,dayE),result}function getWeekNumber(day){let j;j=0==day.getDay()?day.getDate()+1:day.getDate(),(day=new Date(Date.UTC(day.getFullYear(),day.getMonth(),j))).setUTCDate(day.getUTCDate()+4-(day.getUTCDay()||7));const YEAR_START=new Date(Date.UTC(day.getUTCFullYear(),0,1)),WEEK_NUM=Math.ceil(((day-YEAR_START)/864e5+1)/7);return WEEK_NUM}function getYear(day){const YEAR=day.getFullYear();return YEAR}function getParamAnnuel(day){const PARAM=new Object;return PARAM.sem=10*getWeekNumber(day),PARAM.year=getYear(day),PARAM}function goWeek(sem,an){let firstDayAn=new Date;firstDayAn.setUTCFullYear(an,0,1);let firstDayOfYear,firstDayLength=8-firstDayAn.getDay();semLenght=firstDayLength>=4?sem-2:sem-1;let addDays=7*semLenght+firstDayLength+1,finalDate=new Date;finalDate.setFullYear(an,0,addDays);let firstDayOfSem=new Date(finalDate);SCHEDULER.option("currentDate",firstDayOfSem)}function updateContextMenu(disable,data,item,onItemClick,target){CONTEXT_MENU.option({dataSource:data,target:target,itemTemplate:item,onItemClick:onItemClick,disabled:disable})}function onItemClick(contextMenuEvent){return e=>{e.itemData.onItemClick(contextMenuEvent,e)}}function getAppointmentMenuTemplate(itemData){const WRAPPER_TEMPLATE=$("<div />");return itemData.hasOwnProperty("checked")?WRAPPER_TEMPLATE.dxCheckBox({value:itemData.checked,text:itemData.text}):WRAPPER_TEMPLATE.append(itemData.text).addClass("appointment-context-menu"),WRAPPER_TEMPLATE}function getCellMenuTemplate(itemData){const WRAPPER_TEMPLATE=$("<div />");return WRAPPER_TEMPLATE.append(itemData.text).addClass("cell-context-menu"),WRAPPER_TEMPLATE}function groupCell(e){let now=SCHEDULER.option("groupByDate");now=!now,optionText=!0===now?"Grouper par équipe":"Grouper par date",cellContextMenuItems[1].text=optionText,SCHEDULER.option("groupByDate",now)}function createAppointment(e){e.component.showAppointmentPopup({startDate:new Date(e.cellData.startDate),endDate:new Date(e.cellData.startDate.getTime()+18e5),equipeID:e.cellData.groups.equipeID},!0)}function showCurrentDate(e){e.component.option("currentDate",new Date)}function showAppointment(e){e.component.showAppointmentPopup(e.appointmentData)}function deleteAppointment(e){e.component.deleteAppointment(e.appointmentData),createItemElement(e.appointmentData,$(`#list${e.appointmentData.devis.typeID}`)),$(`.sem-${getWeekNumber(SCHEDULER.option("currentDate"))}`).css("display","block")}function duplicateAppointment(e){const APPOINTMENT=e.targetedAppointmentData;!APPOINTMENT.sdc||delete APPOINTMENT.sdc,delete APPOINTMENT.id,e.component.addAppointment(APPOINTMENT)}function changeStatut(e,clickEvent){const APPOINTMENT=e.appointmentData;e.component.updateAppointment(APPOINTMENT,$.extend(APPOINTMENT,{statut:clickEvent.itemData.text}))}function salAppointment(e,clickEvent){CONTEXT_MENU.option({disable:!0});const APPOINTMENT=e.appointmentData,SALARIE=APPOINTMENT.salarieID,SALARIE_ITEM=clickEvent.itemData.id;-1!=$.inArray(SALARIE_ITEM,SALARIE)?SALARIE.splice(SALARIE.indexOf(SALARIE_ITEM),1):SALARIE.push(SALARIE_ITEM),e.component.updateAppointment(APPOINTMENT,$.extend(APPOINTMENT,{salarieID:SALARIE})),CONTEXT_MENU.show()}function createList(data){const LISTE=$.each(data,(i,item)=>{createItemElement(item,$(`#list${item.devis.typeID}`))})}function createItemElement(item,container){let classSem;classSem=1==item.devis.typeID?`itemSem sem-${item.contrat.sem}`:"",$("<div />").text(item.devis.text).addClass(`item dx-card dx-theme-background-color dx-theme-text-color item${item.devis.dvs_ref} ${classSem}`).appendTo(container).click(()=>{createPopupDevisInfo(item)}).dxDraggable({group:"dragging",data:item,clone:!0,onDragEnd:e=>{e.toData&&(e.cancel=!0),e.cancel=!1===isDrag},onDragMove:e=>{let hoverCell;$(".dx-scheduler-date-table-droppable-cell").hasClass("dx-template-chome")?(isDrag=!1,createToast(ALERT_APPOINTMENT_DISABLE)):isDrag=!0},onDragStart:e=>{e.itemData=e.fromData}}),$(".itemSem").css("display","none"),$(`.sem-${getWeekNumber(SCHEDULER.option("currentDate"))}`).css("display","block")}function createOptionGroupByDate(){const WRAPPER_SWITCH=$("<div />").addClass("switchGroupe option-groupe"),WRAPPER_SWITCH_TITLE=$("<span />").text("Grouper par date").addClass("switchGroupLabel");$(".groupChanged").append(WRAPPER_SWITCH_TITLE).append(WRAPPER_SWITCH);const GROUP_BY_DATE_OPTION=$(".switchGroupe").dxSwitch({name:"groupByDate",width:30,value:!0,onValueChanged:args=>{SCHEDULER.option("groupByDate",args.value),SCHEDULER.on([{repaint:afterRepaint()}])}})}function createOptionTeams(){$(".switchEquip").empty();let array=PARAM_STORE._array[0].teams;$.each(TEAMS_STORE._array,(el,value)=>{let startDate=value.startDate,endDate=value.endDate,j=SCHEDULER.option("currentDate");if(new Date(startDate).getTime()<=j&&new Date(endDate).getTime()>=j){let val;val=-1!==array.indexOf(value.id),$("<div />").attr("id",`checkboxTeam${value.id}`).addClass("checkboxTeam").appendTo(".switchEquip");const CHECKBOX=$(`#checkboxTeam${value.id}`).dxCheckBox({text:value.text,value:val,onValueChanged:e=>{!0===e.value?(array.push(value.id),SCHEDULER.option("resources[0].dataSource",getDataTeams(array,SCHEDULER.option("currentDate"))),PARAM_STORE.update(PARAM_STORE._array[0].id,{teams:array})):(array=array.filter(e=>e!==value.id),0==array.length?(createToast(ALERT_TEAM),CHECKBOX.option("value",!0)):(SCHEDULER.option("resources[0].dataSource",getDataTeams(array,SCHEDULER.option("currentDate"))),PARAM_STORE.update(PARAM_STORE._array[0].id,{teams:array})))}}).dxCheckBox("instance")}})}function createButtonOption(e){const WRAPPER_BTN=$("<div />").addClass("bt-option"),BTN=$("<div />").addClass("button-option");WRAPPER_BTN.append(BTN),e.group.append(WRAPPER_BTN),BTN.dxButton({text:e.text,icon:e.icon,elementAttr:{class:e.className},type:"normal",onClick:()=>{if(e.event.fmScript){if(e.event.fmScript.param){let func=e.event.fmScript.param;param=func()}else param="";return queryToFM(new queryFM(e.event.fmScript.name,param,0)),!0}{let func,param;(0,e.event.intern.name)(e.event.intern.param)}}})}function ficheTravSemaine(){let result;const ficheTrav=new DevExpress.data.DataSource({paginate:!1,store:APPOINTMENT_STORE,filter:[["startDate",">",getDateFormatAAAAMMDD_H(SCHEDULER.getStartViewDate())],"and",["endDate","<",getDateFormatAAAAMMDD_H(SCHEDULER.getEndViewDate())]],sort:"startDate"});return ficheTrav.load().done(r=>{result=JSON.stringify(ficheTrav._items)}),result}function ficheTrav(e){let ficheTrav=[];ficheTrav.push(e.appointmentData);const PARAM=JSON.stringify(ficheTrav);queryToFM(new queryFM("Creation_fiche_chantier",PARAM,0))}function contactClient(e){getDataClient(e.appointmentData.devis.client.clt_ref),setDataClient=val=>{clt=JSON.parse(val),createPopupContacter(e,clt)}}function createPopupOption(param){class CREATE_POPUP{constructor(popupContentOption){this.contentOption=popupContentOption,this.startPopup=()=>{if(popupOption)popupOption=$("#popupOption").dxPopup(popupContentOption).dxPopup("instance");else{let container=$("<div />").attr("id","popupOption").appendTo("#planning");popupOption=$("#popupOption").dxPopup(popupContentOption).dxPopup("instance")}popupOption.show()}}}const CREATED_POPUP=new CREATE_POPUP(param.contentOption);CREATED_POPUP.startPopup()}function createToast(param){class CREATE_TOAST{constructor(param){this.startToast=()=>{if(toastOption)toastOption=$("#toast").dxToast(param).dxToast("instance");else{let wrapper=$("<div />").attr("id","toast").appendTo("#planning");toastOption=wrapper.dxToast(param).dxToast("instance")}toastOption.show()}}}const CREATED_TOAST=new CREATE_TOAST(param);CREATED_TOAST.startToast()}function createPopupDevisInfo(e){popupDevisInfo?popupDevisInfo.option({contentTemplate:popupDevisInfoContent(e).contentTemplate.bind(this)}):($("<div />").attr("id","popup-devis-info").appendTo("#planning"),popupDevisInfo=$("#popup-devis-info").dxPopup(popupDevisInfoContent(e)).dxPopup("instance")),popupDevisInfo.show()}function createPopupTimeResult(e){popupTimeResult?popupTimeResult.option({contentTemplate:popupTimeResultContent(e).contentTemplate.bind(this),title:"suivi de chantier"}):($("<div />").attr("id","popup-time-result").appendTo("#planning"),popupTimeResult=$("#popup-time-result").dxPopup(popupTimeResultContent(e)).dxPopup("instance")),popupTimeResult.show()}function createPopupAddClient(item,e){$("<div />").attr("id","popup-new-client").appendTo("#planning"),popupAddClient=$("#popup-new-client").dxPopup(popupAddClientContent(item,e)).dxPopup("instance"),popupAddClient.show()}function createPopupContacter(e,clt){popupContacter?popupContacter.option({contentTemplate:popupContacterContent(e,clt).contentTemplate.bind(this),title:e.appointmentData.devis.text}):($("<div />").attr("id","popup-contact").appendTo("#planning"),popupContacter=$("#popup-contact").dxPopup(popupContacterContent(e,clt)).dxPopup("instance")),popupContacter.show()}function createPopupSMS(e,smsTel,clt){popupSMS?popupSMS.option({contentTemplate:popupSMSContent(e,smsTel,clt).contentTemplate.bind(this),title:"sms"}):($("<div />").attr("id","popup-sms").appendTo("#planning"),popupSMS=$("#popup-sms").dxPopup(popupSMSContent(e,smsTel,clt)).dxPopup("instance")),popupSMS.show()}function sendInBlue(num,content){let options={method:"POST",headers:{accept:"application/json","content-type":"application/json","api-key":"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"},body:JSON.stringify({type:"transactional",unicodeEnabled:!1,sender:"33610225002",recipient:num,content:content,organisationPrefix:"Proxim Jardin"})},url;fetch("https://api.brevo.com/v3/transactionalSMS/sms",options).then(response=>response.json()).then((function(){createToast(ALERT_SMS_SUCCESS)})).catch(error=>console.log(error))}function popupDevisInfoContent(e){let appointment;appointment=e.appointmentData?e.appointmentData:e;const DEVIS_INFO_POPUP={width:500,height:450,showTitle:!0,title:"Information sur le devis",visible:!1,dragEnabled:!0,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"rgba(134, 134, 134, 0.70)",wrapperAttr:{class:"devis-info-popup"},contentTemplate:()=>{const WRAPPER_DEVIS_INFO_POPUP=$("<div />"),WRAPPER_DEVIS_INFO=$("<div />").appendTo(WRAPPER_DEVIS_INFO_POPUP).addClass("wrapper-info-devis-form").css("margin-top","5px");WRAPPER_DEVIS_INFO.dxForm({readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:200,height:"auto",colCount:1,showValidationSummary:!1,validationGroup:"formDevisInfo",items:[{itemType:"group",cssClass:"adresse-group",colCount:3,items:[{name:"adresse",dataField:"adresse",colSpan:3,label:{text:"Adresse chantier",visible:!1},editorOptions:{value:appointment.devis.adresse.adrch,disabled:!1,readOnly:!0}},{dataField:"ville",colSpan:2,label:{text:"Ville",visible:!1},editorOptions:{value:appointment.devis.adresse.adrch_ville,disabled:!1,readOnly:!0}},{name:"button_nouveau_client",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"map",type:"success",elementAttr:{class:"button-map"},onClick:()=>{let param=new Object;param.adresse=appointment.devis.adresse;const PARAM=JSON.stringify(param);queryToFM(new queryFM("map adresse chantier",PARAM,0))}}}]}]}).dxForm("instance");const WRAPPER_CONTENU_DEVIS_INFO=$("<div />").addClass("ja-textarea").appendTo(WRAPPER_DEVIS_INFO_POPUP),WRAPPER_CONTENU=$("<div />").attr("id","contenu_devis").addClass("container-cont").appendTo(WRAPPER_CONTENU_DEVIS_INFO),WRAPPER_TOOLBAR_DETAIL=$("<div />").addClass("toolbar-time-result").appendTo(WRAPPER_CONTENU_DEVIS_INFO),TREELIST_DETAIL_DEVIS=WRAPPER_CONTENU.dxTreeList({dataSource:appointment.devis.detail.cont,itemsExpr:"sub_cont",dataStructure:"tree",columns:[{dataField:"descr",caption:"Description",cellTemplate(container,e){const DESCR=e.data.descr;container.append($("<span>",{class:"descr",html:DESCR}))}},{dataField:"h_prevu",caption:"H"}],selection:{mode:"multiple",recursive:!0},autoExpandAll:!0,showRowLines:!0,showBorders:!0,columnAutoWidth:!0,wordWrapEnabled:!0,onRowPrepared:e=>{0!=e.level&&"header"!==e.rowType||e.rowElement.find("td").css("font-weight","1000")},onCellPrepared:e=>{"data"==e.rowType&&0==e.row.level&&e.cellElement.find("div.dx-treelist-icon-container").remove()},onNodesInitialized:e=>{let arraySelectedRow=new Array;TREELIST_DETAIL_DEVIS.forEachNode((function(node){let nodeData=node.data;if(1===nodeData.termine){let valeurId=nodeData.id;arraySelectedRow.push(valeurId)}})),TREELIST_DETAIL_DEVIS.option("selectedRowKeys",arraySelectedRow)}}).dxTreeList("instance"),TOOLBAR_DETAIL=WRAPPER_TOOLBAR_DETAIL.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"valider",onClick:()=>{const SCDVS_SELECTED=TREELIST_DETAIL_DEVIS.getSelectedRowKeys("leavesOnly");$.each(appointment.devis.detail.cont,(i,cont)=>{$.each(cont.sub_cont,(i,sub_cont)=>{SCDVS_SELECTED.includes(sub_cont.id)?sub_cont.termine=1:sub_cont.termine=0})}),e.component.updateAppointment(appointment,appointment);let result=new Object;result.data=SCDVS_SELECTED,result.structure=appointment.devis.structure,result.dvs_ref=appointment.devis.dvs_ref,result=JSON.stringify(result),queryToFM(new queryFM("scdvsTermine",result,0)),popupDevisInfo.hide()}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",onClick:()=>{popupDevisInfo.hide()}}}]}).dxToolbar("instance");return WRAPPER_DEVIS_INFO_POPUP.dxScrollView({height:"100%",width:"100%"}).dxScrollView("instance"),WRAPPER_DEVIS_INFO_POPUP}};return DEVIS_INFO_POPUP}function popupTimeResultContent(e){const TIME_RESULT_POPUP={width:700,height:450,showTitle:!0,title:"Temps passé sur le chantier",visible:!1,dragEnabled:!0,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"rgba(134, 134, 134, 0.70)",wrapperAttr:{class:"time-result-popup"},contentTemplate:()=>{const WRAPPER_TIME_RESULT_POPUP=$("<div />"),WRAPPER_TIME_RESULT=$("<div />").appendTo(WRAPPER_TIME_RESULT_POPUP),WRAPPER_TIME_RESULT_GRID=$("<div />").appendTo(WRAPPER_TIME_RESULT_POPUP),WRAPPER_TOOLBAR_TIME_RESULT=$("<div />").addClass("toolbar-time-result").appendTo(WRAPPER_TIME_RESULT_POPUP),APPOINTMENT=e.appointmentData;let data_worker,sdc;sdc=!(!APPOINTMENT.sdc||0==APPOINTMENT.sdc.length),data_worker=sdc?APPOINTMENT.sdc:new Array;const MASK_HEURE={H:char=>char>=0&&char<=2,h:(char,index,fullStr)=>"2"==fullStr[0]?[0,1,2,3].includes(parseInt(char)):[0,1,2,3,4,5,6,7,8,9].includes(parseInt(char)),M:char=>char>=0&&char<=5,m:char=>char>=0&&char<=9},DATE=getDateFormatDDMMAAAA(new Date(APPOINTMENT.startDate)),DVS_REF=APPOINTMENT.devis.dvs_ref;sdc||$.each(APPOINTMENT.salarieID,(i,elem)=>{let objWorker=new Object;SALARIE_STORE.load({filter:["id",elem]}).done(result=>{const NAME=`${result[0].prenom} ${result[0].nom}`;objWorker.salarie_name=NAME,objWorker.dvs_ref=DVS_REF,objWorker.date=DATE}),data_worker.push(objWorker)});const GRID_TIME_RESULT=WRAPPER_TIME_RESULT_GRID.dxDataGrid({dataSource:data_worker,showBorders:!0,editing:{mode:"popup",allowUpdating:!0,allowAdding:!0,allowDeleting:!0,popup:{showTitle:!1,width:500,height:350},form:{items:[{itemType:"group",colSpan:2,colCount:2,items:[{dataField:"salarie_name",editorType:"dxSelectBox",editorOptions:{dataSource:SALARIE_SOURCE,valueExpr:e=>{if(null!=e)return`${e.prenom} ${e.nom}`},displayExpr:e=>{if(null!=e)return`${e.prenom} ${e.nom}`}}}]},{itemType:"group",colSpan:2,colCount:3,items:[{dataField:"heure_a"},{dataField:"heure_d"},{dataField:"trajet"}]},{itemType:"group",colCount:2,items:[{dataField:"pause_a"},{dataField:"pause_d"}]}]}},columns:[{allowEditing:!1,dataField:"appointmentID",visible:!1},{dataField:"salarie_name",caption:"Nom",validationRules:[{type:"required",message:"requis"}]},{dataField:"heure_a",caption:"heure d'arrivée",editorOptions:{mask:"Hh:Mm",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"heure_d",caption:"heure de départ",editorOptions:{mask:"Hh:Mm",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"trajet",caption:"temps de trajet",validationRules:[{type:"required",message:"requis"}]},{dataField:"pause_a",caption:"début de pause",editorOptions:{mask:"Hh:Mm",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"pause_d",caption:"fin de pause",editorOptions:{mask:"Hh:Mm",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"}}],onRowInserting:e=>{e.data.date=DATE,e.data.dvs_ref=DVS_REF,e.data.pause_a||(e.data.pause_a=""),e.data.pause_d||(e.data.pause_d="")}}).dxDataGrid("instance");if(!sdc){const FORM_TIME_RESULT=WRAPPER_TIME_RESULT.dxForm({readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:200,height:"auto",colCount:1,showValidationSummary:!1,validationGroup:"formTimeResult",items:[{itemType:"group",cssClass:"info-group",colCount:3,items:[{dataField:"heure_a",label:{text:"Heure d'arrivée",visible:!1},editorOptions:{value:"",mask:"Hh:Mm",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"},validationRules:[{type:"required",message:"requis"}]},{dataField:"heure_d",label:{text:"Heure de départ",visible:!1},editorOptions:{value:"",mask:"00:00",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"},validationRules:[{type:"required",message:"requis"}]},{dataField:"trajet",label:{text:"Temps de trajet",visible:!1},editorOptions:{value:""},validationRules:[{type:"required",message:"requis"}]},{dataField:"pause_a",label:{text:"début de pause",visible:!1},editorOptions:{value:"",mask:"00:00",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"pause_d",label:{text:"fin de pause",visible:!1},editorOptions:{value:"",mask:"00:00",maskRules:MASK_HEURE,useMaskedValue:!0,showMaskMode:"onFocus"}}]}],onFieldDataChanged:e=>{$.each(data_worker,(i,elem)=>{"heure_a"==e.dataField?elem.heure_a=e.value:"heure_d"==e.dataField?elem.heure_d=e.value:"trajet"==e.dataField?elem.trajet=e.value:"pause_a"==e.dataField?elem.pause_a=e.value:elem.pause_d=e.value}),GRID_TIME_RESULT.refresh()}}).dxForm("instance")}if(sdc){const TOOLBAR_TIME_RESULT=WRAPPER_TOOLBAR_TIME_RESULT.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"valider",onClick:()=>{let dataSource=GRID_TIME_RESULT.option("dataSource");if(0==dataSource.length)dataSource=JSON.stringify(dataSource),queryToFM(new queryFM("createSuiviChantier",dataSource,0)),popupTimeResult.hide();else{e.component.updateAppointment(APPOINTMENT,$.extend(APPOINTMENT,{sdc:dataSource}));let result=new Object;result.data=dataSource,result.structure=APPOINTMENT.devis.structure,result.appointmentID=APPOINTMENT.id,result=JSON.stringify(result),queryToFM(new queryFM("createSuiviChantier",result,0)),popupTimeResult.hide()}}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",onClick:()=>{popupTimeResult.hide()}}}]}).dxToolbar("instance")}else{const TOOLBAR_TIME_RESULT=WRAPPER_TOOLBAR_TIME_RESULT.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"valider",validationGroup:"formTimeResult",onClick:function validate(params){let valid;if(!0===params.validationGroup.validate().isValid){let dataSource=GRID_TIME_RESULT.option("dataSource");e.component.updateAppointment(APPOINTMENT,$.extend(APPOINTMENT,{sdc:dataSource}));let result=new Object;result.data=dataSource,result.structure=APPOINTMENT.devis.structure,result.appointmentID=APPOINTMENT.id,result=JSON.stringify(result),queryToFM(new queryFM("createSuiviChantier",result,0)),popupTimeResult.hide()}}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",onClick:()=>{popupTimeResult.hide()}}}]}).dxToolbar("instance")}return WRAPPER_TIME_RESULT_POPUP}};return TIME_RESULT_POPUP}function popupContacterContent(e,clt){const CONTACT_POPUP={colCount:2,width:390,height:350,showTitle:!0,title:e.appointmentData.devis.text,visible:!1,dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"rgba(134, 134, 134, 0.70)",wrapperAttr:{class:"popup-contacter"},contentTemplate:()=>{const WRAPPER_CONTACT_POPUP=$("<div />").addClass("containerContact"),WRAPPER_TEL=$("<div />").appendTo(WRAPPER_CONTACT_POPUP),TEL_NUM=$("<div />").addClass("tel-content").appendTo(WRAPPER_TEL);let tel1,tel2,smsTel,mail;if(clt.hasOwnProperty("contact")?($("<div />").html(`<p>Les informations de contact suivante sont celles de ${clt.contact.nom}</br>${clt.contact.observation} </p>`).prependTo(WRAPPER_CONTACT_POPUP),tel1=clt.contact.tel1,tel2=clt.contact.tel2,mail=clt.contact.mail,contactNom=clt.contact.nom):(tel1=clt.tel1,tel2=clt.tel2,mail=clt.mail,contactNom=""),"06"===tel2.substring(0,2)||"07"===tel2.substring(0,2)?smsTel=tel2:"06"!==tel1.substring(0,2)&&"07"!==tel1.substring(0,2)||(smsTel=tel1),$("<div />").addClass("tel").dxTextBox({value:tel1,readOnly:!0,label:"Téléphone",labelMode:"static"}).appendTo(TEL_NUM),$("<div />").addClass("tel").dxTextBox({value:tel2,readOnly:!0}).appendTo(TEL_NUM),void 0!==smsTel){const WRAPPER_SMS_BUTTON=$("<div />").addClass("sms-button-content").appendTo(WRAPPER_TEL),SMS_BUTTON=$("<div />").addClass("button-mail");SMS_BUTTON.dxButton({width:120,text:"SMS",type:"success",onClick:()=>{createPopupSMS(e,smsTel,clt)}}).appendTo(WRAPPER_SMS_BUTTON)}if(0!=mail.length){const WRAPPER_MAIL=$("<div />").appendTo(WRAPPER_CONTACT_POPUP).css({"margin-top":"40px"}),MAIL_CONTENT=$("<div />").addClass("mail-content").appendTo(WRAPPER_MAIL);$("<div />").addClass("mail").dxTextBox({value:mail,readOnly:!0,label:"Email",labelMode:"static"}).appendTo(MAIL_CONTENT);const BUTTON_MAIL=$("<div />").addClass("button-mail");BUTTON_MAIL.dxButton({width:120,text:"mail",type:"success",onClick:()=>{let mailText=getConfirmationMsg(e.appointmentData,clt,"mail"),param={mail:mail,mailText:mailText};param=JSON.stringify(param),queryToFM(new queryFM("creation_mail",param,0)),e.component.updateAppointment(e.appointmentData,$.extend(e.appointmentData,{statut:"Message"}))}}).appendTo(MAIL_CONTENT)}return WRAPPER_CONTACT_POPUP}};return CONTACT_POPUP}function popupSMSContent(e,smsTel,clt){const SMS_POPUP={colCount:1,width:390,height:350,showTitle:!0,title:"sms",visible:!1,dragEnabled:!1,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"rgba(134, 134, 134, 0.70)",wrapperAttr:{class:"popup-sms"},contentTemplate:()=>{const WRAPPER_SMS_POPUP=$("<div />").addClass("containersms"),WRAPPER_SMS=$("<div />").appendTo(WRAPPER_SMS_POPUP);smsText=getConfirmationMsg(e.appointmentData,clt,"sms"),$("<div />").addClass("sms").dxTextArea({value:smsText,readOnly:!1,label:"texte",labelMode:"static",height:200,onValueChanged:function(e){smsText=e.value}}).appendTo(WRAPPER_SMS);const WRAPPER_SMS_BUTTON=$("<div />").addClass("sms-button-content").appendTo(WRAPPER_SMS),SMS_BUTTON=$("<div />").addClass("button-sms");return SMS_BUTTON.dxButton({text:"envoyer",width:150,type:"success",onClick:()=>{sendInBlue(smsNumTel(smsTel),smsText),$("#popup-sms").dxPopup("hide")}}).appendTo(WRAPPER_SMS_BUTTON),WRAPPER_SMS_POPUP}};return SMS_POPUP}function popupAddClientContent(item,e){let formAddClient;const ADD_CLIENT_POPUP={width:500,height:450,showTitle:!0,title:"ajouter un client",visible:!1,dragEnabled:!0,closeOnOutsideClick:!0,shading:!1,wrapperAttr:{class:"addClient-popup"},contentTemplate:()=>{const WRAPPER_ADD_CLIENT_POPUP=$("<div />").addClass("wrapper-AddClient-popup").dxScrollView({width:"100%",height:"100%"});return formAddClient=WRAPPER_ADD_CLIENT_POPUP.dxForm({readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:200,height:320,colCount:1,showValidationSummary:!1,validationGroup:"addClient",items:[{itemType:"group",cssClass:"nom-group",colCount:5,items:[{dataField:"civilite",colSpan:1,label:{text:"Civilité",visible:!1},editorType:"dxSelectBox",editorOptions:{items:["M","Mme","M et Mme","M et M","Mme et Mme"],value:"",disabled:!1,onOpened:e=>{setTimeout(()=>{e.component.content().parent().width(140)})}},validationRules:[{type:"required",message:"la civilité est requise"}]},{name:"nom",dataField:"nom",colSpan:2,label:{text:"Nom",visible:!1},editorOptions:{value:"",disabled:!1,width:150},validationRules:[{type:"required",message:"le nom est requis"}]},{dataField:"prenom",colSpan:2,label:{text:"prénom",visible:!1},editorOptions:{value:"",disabled:!1,width:150},validationRules:[{type:"required",message:"le prénom est requis"}]}]},{itemType:"group",cssClass:"adresse-group",colCount:1,items:[{dataField:"adres1",label:{text:"Adresse",visible:!1},editorOptions:{value:"",disabled:!1},validationRules:[{type:"required",message:"l'adresse est requise"}]},{dataField:"adres2",label:{text:"",visible:!1},editorOptions:{value:"",disabled:!1}},{itemType:"group",cssClass:"cp-ville-group",colCount:5,items:[{dataField:"cp",label:{text:"CP",visible:!1},editorOptions:{value:"",disabled:!1,mask:"00000"},validationRules:[{type:"required",message:"le code postal est requis"}]},{dataField:"ville",colSpan:4,label:{text:"Ville",visible:!1},editorOptions:{value:"",disabled:!1},validationRules:[{type:"required",message:"la ville est requise"}]}]}]},{itemType:"group",cssClass:"contact-group",colCount:2,items:[{dataField:"tel1",label:{text:"Telephone",visible:!1},editorOptions:{value:"",disabled:!1,mask:"00 00 00 00 00"}},{dataField:"mail1",label:{text:"Email",visible:!1},editorOptions:{value:"",disabled:!1}},{dataField:"tel2",label:{text:"Telephone",visible:!1},editorOptions:{value:"",mask:"00 00 00 00 00"}},{dataField:"mail2",label:{text:"Email",visible:!1},editorOptions:{value:"",disabled:!1}}]}]}).dxForm("instance"),WRAPPER_ADD_CLIENT_POPUP},toolbarItems:[{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"ok",validationGroup:"addClient",onClick:function validate(params){const VALID=params.validationGroup.validate();if(!0===VALID.isValid){const NEW_CLIENT=formAddClient._options._optionManager._options.formData;let param=JSON.stringify(NEW_CLIENT);param=echapElem(param),queryToFM(new queryFM("Creation_client",param,0));const ADRESS=NEW_CLIENT.adres2?`${NEW_CLIENT.adres1}\n${NEW_CLIENT.adres2}`:`${NEW_CLIENT.adres1}`,TITLE=`${NEW_CLIENT.nom} ${NEW_CLIENT.prenom}`,CLIENT_TEXT=`${ADRESS}\n${NEW_CLIENT.ville}\n${NEW_CLIENT.tel1}\n${NEW_CLIENT.tel2}`;e.form.option("items[0].items[0].editorOptions.value",TITLE),e.form.option("items[2].items[0].editorOptions.value",CLIENT_TEXT),e.form.option("items[2].items[2].editorOptions.value",item.clt_ref),popupAddClient.hide(),$("#popup-new-client").remove()}}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",onClick:e=>{popupAddClient.hide(),$("#popup-new-client").remove()}}}]};return ADD_CLIENT_POPUP}function tagBoxEquipeDefautSalId(cellElement,cellInfo){let salarie;SALARIE_SOURCE.filter("actif",1),SALARIE_SOURCE.load().done(result=>{salarie=result});const TAGBOX_SALARIE=$("<div>").dxTagBox({dataSource:salarie,value:cellInfo.value,valueExpr:"id",displayExpr:"prenom",showSelectionControls:!0,maxDisplayedTags:3,showMultiTagOnly:!1,applyValueMode:"useButtons",searchEnabled:!0,onValueChanged:e=>{cellInfo.setValue(e.value)},onSelectionChanged:()=>{cellInfo.component.updateDimensions()},onOpened:e=>{e.component._popup.option("width",230)}});return TAGBOX_SALARIE}function colorPickerEquipe(cellElement,cellInfo){return $("<div>").dxColorBox({value:cellInfo.value,onValueChanged:e=>{cellInfo.setValue(e.value)},applyButtonText:"ok"})}function create_UUID(){let dt=(new Date).getTime(),uuid;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{let r=(dt+16*Math.random())%16|0;return dt=Math.floor(dt/16),("x"==c?r:3&r|8).toString(16)})}function echapElem(chaine){return chaine=(chaine=chaine.replace(/'/g,"''")).replace(/\n|\r|(\n\r)/g,"/r")}function getDateFormatAAAAMMDD(date){let m=date.getMonth()+1,d=date.getDate(),a;return d<10&&(d=`0${d}`),m<10&&(m=`0${m}`),`${date.getFullYear()}/${m}/${d}`}function getDateFormatAAAAMD(date){let m=date.getMonth()+1,d=date.getDate(),a;return`${date.getFullYear()}/${m}/${d}`}function getDateFormatDDMMAAAA_AAAAMD(date){var dateParts=date.split("/");return`${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`}function getDateFormatDDMMAAAA(date){let m=date.getMonth()+1,d=date.getDate(),a=date.getFullYear(),h=date.getHours(),n=date.getMinutes(),s=date.getSeconds();return d<10&&(d=`0${d}`),m<10&&(m=`0${m}`),`${d}/${m}/${a}`}function getDateFormatAAAAMMDD_H(date){let m=date.getMonth()+1,d=date.getDate(),a=date.getFullYear(),h=date.getHours(),n=date.getMinutes(),s=date.getSeconds();return d<10&&(d=`0${d}`),m<10&&(m=`0${m}`),h<10&&(h=`0${h}`),n<10&&(n=`0${n}`),s<10&&(s=`0${s}`),`${a}/${m}/${d} ${h}:${n}:${s}`}function getRDVPeriode(e){let date=new Date(e),m=date.getMonth(),j=date.getDay(),d=date.getDate(),h=60*date.getHours()+date.getMinutes(),nomJour=new Array("dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"),nomMois=new Array("janvier","février","mars","avril","mai","juin","juillet"," août","septembre","octobre","novembre","décembre"),periode=new Array("dès 8h15/8h30","en début de matinée","en milieu de matinée","en fin de matinée ou début d'après-midi","en début d'après-midi","vers 15h30");return p=h<540?0:h<600?1:h<690?2:h<840?3:h<900?4:5,`${nomJour[j]} ${d} ${nomMois[m]} ${periode[p]}`}function getConfirmationMsg(e,clt,type){let confirmationMsg;return confirmationMsg=e.devis.hasOwnProperty("detail")?e.contrat.hasOwnProperty("an")?`Bonjour ${clt.hasOwnProperty("contact")?`${clt.contact.nom}`:`${clt.nom}`}\n\nUne intervention est prévue ${clt.hasOwnProperty("contact")?`chez ${clt.nom}`:""} le ${getRDVPeriode(e.startDate)}\n\nCordialement\n${"sms"==type?"PROXIM JARDIN\n\nPour nous joindre par téléphone: 02 43 81 07 14":""}`:`Bonjour ${clt.hasOwnProperty("contact")?`${clt.contact.nom}`:`${clt.nom}`}\n\nL'intervention ${e.devis.description[0].toLowerCase().match(/[aeiouyéè]/g)?"d'":"de "}${e.devis.description.toLowerCase()} est prévue ${clt.hasOwnProperty("contact")?`chez ${clt.nom}`:""} le ${getRDVPeriode(e.startDate)}\n\nCordialement\n${"sms"==type?"PROXIM JARDIN\n\nPour nous joindre par téléphone: 02 43 81 07 14":""}`:`Bonjour ${clt.nom}\n\nJe vous confirme notre rendez-vous le ${getRDVDevisPeriode(e.startDate)}\n\nCordialement\n${"sms"==type?"PROXIM JARDIN\n\nPour nous joindre par téléphone: 02 43 81 07 14":""}`,confirmationMsg}function getRDVDevisPeriode(e){let date=new Date(e),m=date.getMonth(),j=date.getDay(),d=date.getDate(),h=date.getHours(),mn=date.getMinutes(),nomJour=new Array("dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"),nomMois=new Array("janvier","février","mars","avril","mai","juin","juillet"," août","septembre","octobre","novembre","décembre");return mn<10&&(mn=`0${mn}`),0==mn&&(mn=""),`${nomJour[j]} ${d} ${nomMois[m]} à ${h} heure ${mn}`}function smsNumTel(num){let n=num.replace(/\s+/g,"");return n=n.substring(1),n=`33${n}`,n}function getDataClient(val){return queryToFM(new queryFM("getDataClient",val,0)),!0}function getDataAppointmentFM(day){let dayStartEnd=dateStartEndCurrentSem(day),dayS=dayStartEnd.dateStart,param=JSON.stringify(dayStartEnd);return appointmentDownloaded.includes(dayS)||(appointmentDownloaded.push(dayS),queryToFM(new queryFM("getDataAppointment",param,0))),!0}function getDataAnnuelFM(p){let param=JSON.stringify(p);return queryToFM(new queryFM("getDataAnnuel",param,0)),!0}function appointementChangeFM(e){let param=JSON.stringify(e);return queryToFM(new queryFM("maj_Appointment",param,0)),!0}function SQL_UpdateFM(table,key,value){delete value.id;let sql_val="";$.each(value,(e,val)=>{let newVal;"description"==e&&(val=echapElem(val)),newVal="string"==typeof val||"object"==typeof val?`'${val}'`:val,sql_val=`${sql_val}${val=`${e}!!${newVal}`},`}),sql_val=sql_val.substring(0,sql_val.length-1);const SQL=`!E!UPDATE ${table} SET ${sql_val} WHERE id!!'${key}'`;queryToFM(new queryFM("maj_Planning",SQL,0))}function SQL_InsertFM(table,value){let sql_val="",sql_prop=Object.keys(value).join(",");$.each(value,(e,val)=>{let newVal;"description"==e&&(val=echapElem(val)),newVal="string"==typeof val||"object"==typeof val?`'${val}'`:val,sql_val=`${sql_val}${newVal},`}),sql_val=sql_val.substring(0,sql_val.length-1);const SQL=`!E!INSERT INTO ${table} (${sql_prop}) VALUES (${sql_val})`;queryToFM(new queryFM("maj_Planning",SQL,0))}function SQL_removeFM(table,key){const SQL=`!E!DELETE FROM ${table} WHERE id!!'${key}'`;queryToFM(new queryFM("maj_Planning",SQL,0))}function queryToFM(query){return FileMaker.PerformScriptWithOption(query.script,query.param,query.option),!0}setNotification=val=>{const VAL=JSON.parse(val);createToast({message:VAL.data,type:"success",position:{at:"right top",offset:"-200 50"},displayTime:5e3,width:"auto",animation:{show:{type:"fade",duration:400,from:0,to:1},hide:{type:"fade",duration:400,from:1,to:0}}})},majListAnnuel=val=>{val==getWeekNumber(SCHEDULER.option("currentDate"))&&getDataAnnuelFM(getParamAnnuel(SCHEDULER.option("currentDate")))},setData=val=>{const VAL=JSON.parse(val),EXPR=VAL.store,DATA_STORE=[{store:SALARIE_STORE,event:{name:"salarie"}},{store:TEAMS_STORE,event:{name:"teams",callback:afterTeamsInStore}},{store:CHOME_STORE,event:{name:"chome"}},{store:ABSENCE_STORE,event:{name:"absence"}},{store:OFFICE_STORE,event:{name:"office"}},{store:PARAM_STORE,event:{name:"param"}},{store:APPOINTMENT_STORE,event:{name:"appointment"}},{store:APPOINTMENT_LIST_STORE,event:{name:"appointment_list"}},{store:PONCTUEL_STORE,event:{name:"ponctuel"}},{store:ANNUEL_STORE,event:{name:"annuel"}},{store:CLIENT_STORE,event:{name:"client",callback:afterListClientInStore}}];let arr=$.grep(DATA_STORE,(function(n,i){let result;return n.event.name==EXPR})),store=arr[0].store;store!=ANNUEL_STORE&&store!=PONCTUEL_STORE||store.clear();const DATA=VAL.data;let func;DATA.forEach((e,i)=>{store.push([{type:"insert",data:e,index:i}])}),(0,arr[0].event.callback)()}});